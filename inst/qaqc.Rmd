---
title: "fluxfinder QA/QC"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
params:
  flux_data: ""
  group_column: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
theme_set(theme_bw())

# Read the flux data
if(params$flux_data == "") {
  fd <- readRDS("extdata/LI8200-01S_fluxes")
  groupcol <- "group"
} else {
  fd <- readRDS(params$flux_data)
  groupcol <- params$group_column
}

# Utility function: add labels to the lowest X%
add_labels <- function(x, col1, col2, level, gc = groupcol) {
  absdiff <- abs(x[[col1]] - x[[col2]]) #/ x[[col1]])
  outthere <- absdiff > quantile(absdiff, probs = level)
  x$label <- NA
  if(is.null(gc)) {
    x$label[outthere] <- seq_len(nrow(x))[outthere]
  } else {
    x$label[outthere] <- x[[gc]][outthere]
  }
  return(x)
}

```

File: `r params$flux_data`

Rows of flux data: `r nrow(fd)`

# Flux distribution and outliers

### M81 model fluxes
```{r}
summary(fd$HM81_flux.estimate)
```

### Linear model fluxes
```{r}
summary(fd$lin_flux.estimate)
```

### Robust model fluxes
```{r}
summary(fd$rob_flux.estimate)
```


```{r, distribution}
pd <- rbind(data.frame(Flux = fd$lin_flux.estimate, Type = "Linear"),
            data.frame(Flux = fd$HM81_flux.estimate, Type = "HM81"))
pd <- pd[!is.na(pd$Flux),]
ggplot(pd, aes(Flux, fill = Type)) + geom_histogram(bins = 30, position = "dodge")
```

# Model comparisons

### Linear model versus robust linear model

Fluxes that depart from the 1:1 may have influential outliers in the underlying data.

```{r, linear-versus-robust}
fd <- add_labels(fd, "lin_flux.estimate", "rob_flux.estimate", level = 0.90)
p <- ggplot(fd, aes(lin_flux.estimate, rob_flux.estimate, 
                    color = is.na(label), label = label)) +
  geom_point() +
  ggrepel::geom_text_repel(size = 5, na.rm = TRUE) +
  geom_abline() +
  theme(legend.position = "none")

#if(!is.null(group_column)) p <- p + aes(color = .data[[group_column]])

print(p)
```

### Linear model versus polynomial model

Fluxes that depart from the 1:1 may have nonlinearity issues in the underlying data.

```{r, linear-versus-polynomial}
fd <- add_labels(fd, "lin_r.squared", "poly_r.squared", level = 0.90)
p <- ggplot(fd, aes(lin_r.squared, poly_r.squared, 
                    color = is.na(label), label = label)) +
  geom_point() +
  ggrepel::geom_text_repel(size = 5, na.rm = TRUE) +
  geom_abline() + 
  theme(legend.position = "none")

#if(!is.null(group_column)) p <- p + aes(color = .data[[group_column]])

print(p)
```
